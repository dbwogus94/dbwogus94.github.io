---
layout: post
date: 2022-01-12
title: "[í”„ë¡œì íŠ¸ | BMW] 7. ë¬¸ì œ í•´ê²° - ë‹¤ë¥¸ ë„ë©”ì¸ cookie êµí™˜ ì„¤ì • ê³¼ì •"
tags: [BMW, CORS, ]
categories: [í”„ë¡œì íŠ¸, BMW, ]
mermaid: true
---



### 1. ì¿ í‚¤êµí™˜ì„ í•˜ë ¤ë©´ ë™ì¼ ì¶œì²˜ ì •ì±…ì„ ë”°ë¼ì•¼ í•œë‹¤.



#### 1.1. ë™ì¼ ì¶œì²˜ ì •ì±…(SOP)ì´ë€?


> ë™ì¼ ì¶œì²˜ ì •ì±…(same-origin policy)ì€ ì–´ë–¤Â ì¶œì²˜ì—ì„œ ë¶ˆëŸ¬ì˜¨ ë¬¸ì„œë‚˜ ìŠ¤í¬ë¦½íŠ¸ê°€ ë‹¤ë¥¸ ì¶œì²˜ì—ì„œ ê°€ì ¸ì˜¨ ë¦¬ì†ŒìŠ¤ì™€ ìƒí˜¸ì‘ìš©í•˜ëŠ” ê²ƒì„ ì œí•œí•˜ëŠ” ì¤‘ìš”í•œ ë³´ì•ˆ ë°©ì‹ì…ë‹ˆë‹¤. ë™ì¼ ì¶œì²˜ ì •ì±…ì€ ì ì¬ì ìœ¼ë¡œ í•´ë¡œìš¸ ìˆ˜ ìˆëŠ” ë¬¸ì„œë¥¼ ë¶„ë¦¬í•¨ìœ¼ë¡œì¨ ê³µê²©ë°›ì„ ìˆ˜ ìˆëŠ”Â ê²½ë¡œë¥¼ ì¤„ì—¬ì¤ë‹ˆë‹¤.


ì¦‰, Originì´ ëª¨ë‘ ì¼ì¹˜í•´ì•¼ ë™ì¼ ì¶œì²˜ë¡œ ì¸ì •ëœë‹¤.


![0](/assets/img/2022-01-12-í”„ë¡œì íŠ¸--BMW-7.-ë¬¸ì œ-í•´ê²°---ë‹¤ë¥¸-ë„ë©”ì¸-cookie-êµí™˜-ì„¤ì •-ê³¼ì •.md/0.png)


[MDNì—ì„œ ë§í•˜ëŠ” ì¿ í‚¤ êµí™˜ ê°€ëŠ¥í•œ ë™ì¼ ì¶œì²˜ ì •ì±…](https://developer.mozilla.org/ko/docs/Web/Security/Same-origin_policy)


![1](/assets/img/2022-01-12-í”„ë¡œì íŠ¸--BMW-7.-ë¬¸ì œ-í•´ê²°---ë‹¤ë¥¸-ë„ë©”ì¸-cookie-êµí™˜-ì„¤ì •-ê³¼ì •.md/1.png)

1. Originì´ ì¼ì¹˜í•˜ê³  ê²½ë¡œ(path)ë§Œ ë‹¤ë¥¸ ê²½ìš°ëŠ” ë™ì¼ ì¶œì²˜ì´ë‹¤.
2. í”„ë¡œí† ì½œì´ ë‹¤ë¥´ë‹¤ë©´ ë™ì¼ ì¶œì²˜ê°€ ì•„ë‹ˆë‹¤.
3. í¬íŠ¸ê°€ ë‹¤ë¥´ë‹¤ë©´ ë™ì¼ ì¶œì²˜ê°€ ì•„ë‹ˆë‹¤.
4. í˜¸ìŠ¤íŠ¸ê°€ ë‹¤ë¥´ë‹¤ë©´ ë™ì¼ ì¶œì²˜ê°€ ì•„ë‹ˆë‹¤.


### 2. ì •ì±…ì— ë”°ë¼ Nginxì™€ expressì˜ ì¿ í‚¤ êµí™˜ì´ ì•ˆë˜ëŠ” ì´ìœ 


JWTê°€ ì¿ í‚¤ì— ë„£ì–´ í´ë¼ì´ì–¸íŠ¸ì—ê²Œ ì‘ë‹µë˜ëŠ” ê³¼ì •

1. https://test.iptime.org(443í¬íŠ¸) ë˜ëŠ” http://test.iptime.org(80í¬íŠ¸)ë¡œ ìš”ì²­ì´ ë“¤ì–´ì˜¨ë‹¤.
2. NginxëŠ” ì„¤ì •ì— ë”°ë¼ index.htmlì„ ì‘ë‹µí•œë‹¤.
3. index.htmlì— ì˜í•´ í™”ë©´ì´ ëœë”ë§ ë˜ê³  ìœ ì €ëŠ” ë¡œê·¸ì¸ì„ ìš”ì²­í•œë‹¤.
4. ë¡œê·¸ì¸ì— ì„±ê³µí•˜ë©´ ì„œë²„ëŠ” JWTë¥¼ ë°œê¸‰í•œë‹¤.
5. ê·¸ë¦¬ê³  ë°œê¸‰ëœ JWTë¥¼ ì¿ í‚¤ì— ë„£ì–´ì„œ ë¸Œë¼ìš°ì €ì—ê²Œ ì‘ë‹µí•œë‹¤.
6. ë¸Œë¼ìš°ì €ëŠ” ë™ì¼ ì¶œì²˜ ì •ì±…ì„ ì§€í‚¤ì§€ ì•Šì•˜ê¸° ë•Œë¬¸ì— ë”°ë¼ ì¿ í‚¤ë¥¼ ê±°ë¶€í•œë‹¤.

ë™ì¼ ì¶œì²˜ ì •ì±…ì„ ì§€í‚¤ì§€ ì•Šê²Œëœ ì´ìœ 

- NginxëŠ” 80, 443 í¬íŠ¸ë¥¼ ì‚¬ìš©í•œ ìš”ì²­ë§Œ ì‘ë‹µë˜ë„ë¡ í•œë‹¤.
- ë¦¬ë²„ìŠ¤ í”„ë¡ì‹œ ì„œë²„(api ì„œë²„)ë¡œ ì‚¬ìš©ë˜ëŠ” expressëŠ” 8080 í¬íŠ¸ë¥¼ ì‚¬ìš©í•œë‹¤.
- ê·¸ë ‡ê¸° ë•Œë¬¸ì— **ë™ì¼ ì¶œì²˜ ì •ì±…ì— ì˜í•´ ì¼ë°˜ì ì¸ ë°©ë²•ìœ¼ë¡œëŠ” ë‘ ì„œë²„ê°„ì— ì¿ í‚¤ë¥¼ êµí™˜í•˜ì§€ ëª»í•œë‹¤.**


### 3. ë™ì¼ ì¶œì²˜ë¡œ ì¸ì •ë˜ê¸° ìœ„í•œ ê³¼ì • 3ë‹¨ê³„


ë¡œì»¬ì—ì„œ ë‹¤ë¥¸ í¬íŠ¸ë¥¼ ì‚¬ìš©í•˜ëŠ” í´ë¼ì´ì–¸íŠ¸ì™€ ì„œë²„ê°„ì— ì¿ í‚¤ë¥¼ êµí™˜í•˜ê¸° ìœ„í•´ì„œëŠ” ëª‡ê°€ì§€ ì„¤ì •ì´ í•„ìš”í•˜ë‹¤.


ë¨¼ì € **í´ë¼ì´ì–¸íŠ¸ìª½ì—ì„œëŠ”** ìê²©ì¦ëª… í—¤ë”ê°€ í¬í•¨ëœ **ìê²©ì¦ëª… ìš”ì²­**ì„ í•´ì•¼í•œë‹¤.


**ì„œë²„ëŠ”** í´ë¼ì´ì–¸íŠ¸ê°€ ë‹¤ë¥¸ ì¶œì²˜ì´ê¸° ë•Œë¬¸ì— **cors orign ì„¤ì •**ì„ í•´ì•¼í•œë‹¤.


ë˜í•œ ì„œë²„ëŠ” í´ë¼ì´ì–¸íŠ¸ì—ì„œ ë³´ë‚¸ ìê²©ì¦ëª… ìš”ì²­ì— ëŒ€í•œ ì‘ë‹µ í—¤ë”ì— ì¿ í‚¤ë¥¼ ë‹´ì•„ ë³´ë‚¼ ìˆ˜ ìˆëŠ”ë° ì´ë•Œ,


`Access-Control-Allow-Credentials:true` ë¼ëŠ” í—¤ë”ê°€ ì‘ë‹µì— í¬í•¨ë˜ì§€ ì•Šìœ¼ë©´ ë¸Œë¼ìš°ì €ì—ì„œ í•´ë‹¹ ì‘ë‹µì„ ê±°ë¶€í•œë‹¤.


ì¦‰, í´ë¼ì´ì–¸íŠ¸ëŠ” ìê²©ì¦ëª… ìš”ì²­ì„ í•´ì•¼í•˜ê³ , ì„œë²„ëŠ” cors ì„¤ì •ê³¼ ìê²©ì¦ëª… ìš”ì²­ì— ëŒ€ì‘í•˜ëŠ” `Credentials:true` í—¤ë”ë¥¼ ì‘ë‹µí•´ì•¼ ë‹¤ë¥¸ í¬íŠ¸ê°„ ì¿ í‚¤ë¥¼ ì‚¬ìš©í•œ í†µì‹ ì´ ê°€ëŠ¥í•˜ë‹¤.

- 1ë‹¨ê³„ - ë¡œì»¬ í™˜ê²½ì—ì„œ í¬íŠ¸ê°€ ë‹¤ë¥¸ ì„œë²„ cookie êµí™˜ ì„¤ì •
- 2ë‹¨ê³„ - Nginxì™€ Proxyì„œë²„ cookie êµí™˜ ì„¤ì •
- 3ë‹¨ê³„ - httpsí†µì‹ ì„ ìœ„í•œ ssl ì¸ì¦ì„œ ì„¤ì •


### 4. 1ë‹¨ê³„ - ë¡œì»¬ì—ì„œ í¬íŠ¸ê°€ ë‹¤ë¥¸ ì„œë²„ cookie êµí™˜ ì„¤ì •


ë¡œì»¬ì—ì„œ reactì™€ expressì—ì„œ ì¿ í‚¤êµí™˜ì´ ì•ˆë˜ëŠ” ì´ìœ 

- localhostì—ì„œ reactëŠ” 3000ë²ˆ í¬íŠ¸ë¥¼ ì‚¬ìš©í•œë‹¤.
- localhostì—ì„œ expressëŠ” 8080ë²ˆ í¬íŠ¸ë¥¼ ì‚¬ìš©í•œë‹¤.
- **ë™ì¼ ì¶œì²˜ ì •ì±…**ì— ë”°ë¥´ë©´ í¬íŠ¸ê°€ ë‹¤ë¥¸ ì„œë²„ëŠ” **ë‹¤ë¥¸ ë„ë©”ì¸ìœ¼ë¡œ ì¸ì‹**í•œë‹¤.
- ë•Œë¬¸ì— **expressì—ì„œ ì¿ í‚¤ë¥¼ ë°œí–‰í•˜ì—¬ë„ ë¸Œë¼ìš°ì €ì—ì„œ ì¿ í‚¤ë¥¼ ì €ì¥í•˜ì§€ ì•ŠëŠ”ë‹¤.**

ê²°ë¡  ë¶€í„° ë§í•˜ë©´ í´ë¼ì´ì–¸íŠ¸ì™€ ì„œë²„ ëª¨ë‘ ì„¤ì •ì´ í•„ìš”í•˜ë‹¤.

1. reactì—ì„œëŠ” **fetch APIì˜ ìê²©ì¦ëª…(****`credentials`****)** ì˜µì…˜ì„ ì„¤ì •í•œë‹¤.
2. expressì—ì„œëŠ” **`cors`** **ë¯¸ë“¤ì›¨ì–´ì˜ ì˜µì…˜ ì„¤ì •**ì´ í•„ìš”í•˜ë‹¤.
- * XMLHttpRequest, fetch API, axios ëª¨ë‘ ìê²©ì¦ëª…(**`credentials`**) ì˜µì…˜ì„ ì§€ì›í•œë‹¤.

** project_bmw_frontì˜ ê²½ìš° fetch APIë¥¼ ì‚¬ìš©í•˜ê¸° ë•Œë¬¸ì— fetchAPIë¥¼ ê¸°ì¤€ìœ¼ë¡œ ì„¤ëª…í•œë‹¤.



#### 4.1. í´ë¼ì´ì–¸íŠ¸(react): fetch API ìê²©ì¦ëª…(`credentials`) ì˜µì…˜ ì„¤ì •



{% raw %}
```javascript
const res = await fetch(`http://localhost:8080/api/auth/singup`, {
  /* credentialsì— 'include'ë¡œ ì˜µì…˜ ì„¤ì • */
  credentials: 'include',
  headers: {
    'Content-Type': 'application/json',
    ...options.headers,
  },
});
```
{% endraw %}



Q) [fetch API ](https://developer.mozilla.org/ko/docs/Web/API/Fetch_API/Using_Fetch#%EC%9E%90%EA%B2%A9_%EC%A6%9D%EB%AA%85credentials%EC%9D%B4_%ED%8F%AC%ED%95%A8%EB%90%9C_request_%EC%9A%94%EC%B2%AD)[`credentials`](https://developer.mozilla.org/ko/docs/Web/API/Fetch_API/Using_Fetch#%EC%9E%90%EA%B2%A9_%EC%A6%9D%EB%AA%85credentials%EC%9D%B4_%ED%8F%AC%ED%95%A8%EB%90%9C_request_%EC%9A%94%EC%B2%AD)[ ì˜µì…˜](https://developer.mozilla.org/ko/docs/Web/API/Fetch_API/Using_Fetch#%EC%9E%90%EA%B2%A9_%EC%A6%9D%EB%AA%85credentials%EC%9D%B4_%ED%8F%AC%ED%95%A8%EB%90%9C_request_%EC%9A%94%EC%B2%AD)ì´ë€?

- ê¸°ë³¸ì ìœ¼ë¡œÂ `fetch`ëŠ”Â **ì¿ í‚¤ë¥¼ ë³´ë‚´ê±°ë‚˜ ë°›ì§€ ì•ŠëŠ”ë‹¤.**
- ë•Œë¬¸ì— fetch APIë¥¼ ì‚¬ìš©í•´ ì¿ í‚¤ë¥¼ ì „ì†¡í•˜ë ¤ë©´ **ìê²©ì¦ëª… ì„¤ì •**í•´ì•¼ í•œë‹¤.
- **ìš”ì²­ì— ìê²©ì¦ëª… ì„¤ì •ì„ í•˜ë ¤ë©´** **`credentials`** **ì˜µì…˜ì„ ì‚¬ìš©í•´ì•¼ í•œë‹¤.**
- ê·¸ë¦¬ê³  **ë‹¤ë¥¸ ë„ë©”ì¸ê°„ì— ì¿ í‚¤ë¥¼ ì „ì†¡í•œë‹¤ë©´,** **`credentials`** **ì˜µì…˜ ê°’ì„** **`include`****ë¡œ í•œë‹¤.**


#### 4.1.1. fetch API ìê²©ì¦ëª…(`credentials`)ì—ì„œ ì œê³µí•˜ëŠ” ì˜µì…˜ 3ê°€ì§€

- ë‹¤ë¥¸ Originê°„ êµí™˜ ì„¤ì • - êµì°¨ ì¶œì²˜ ì¿ í‚¤ êµí™˜ ì„¤ì •


{% raw %}
```javascript
credentials: 'include'
```
{% endraw %}


- ê°™ì€ Originê°„ êµí™˜ ì„¤ì • - ë™ì¼ ì¶œì²˜ë§Œ ì¿ í‚¤ êµí™˜ ì„¤ì •


{% raw %}
```javascript
credentials: 'same-origin'
```
{% endraw %}


- ë³´ì•ˆìƒì˜ ì´ìœ ë‚˜ íŠ¹ì •ì´ìœ ë¡œ ìê²©ì¦ëª…ì„ ì‚¬ìš©í•˜ì§€ ì•Šì„ ë•Œ ì‚¬ìš©


{% raw %}
```javascript
credentials: 'omit'
```
{% endraw %}




#### 4.2. ì„œë²„(express): `cors` ë¯¸ë“¤ì›¨ì–´ ìê²©ì¦ëª… ì˜µì…˜ ì„¤ì •



{% raw %}
```javascript
app.use( cors({ origin: true, credentials: true}),);

// OR

app.use( cors({ origin: '<http://localhost:3000>', credentials: true}),);
```
{% endraw %}



> ğŸ’¡ cors ë¯¸ë“¤ì›¨ì–´ `origin` ì„¤ì •ì´ í•„ìš”í•œ ì´ìœ ?

- ë¸Œë¼ìš°ì €ëŠ” ë³´ì•ˆìƒì˜ ì´ìœ ë¡œ client ìŠ¤í¬ë¦½íŠ¸ì—ì„œ ë°œìƒí•œ êµì°¨ ì¶œì²˜ HTTP ìš”ì²­ì„ ì œí•œí•œë‹¤.
(êµì°¨ ì¶œì²˜ëŠ” [ë™ì¼ ì¶œì²˜](https://www.notion.so/cookie-bfcdc0282ce141ea8879dcccd636cead)ê°€ ì•„ë‹Œ ìš”ì²­ì„ ë§í•œë‹¤.)
- ê·¸ë¦¬ê³  [cors(Cross-Origin Resource Sharing)](https://developer.mozilla.org/ko/docs/Web/HTTP/CORS)ëŠ” êµì°¨ ì¶œì²˜ ìš”ì²­ì„ í•  ìˆ˜ ìˆë„ë¡ í•˜ëŠ” ì‹œìŠ¤í…œì´ë‹¤.
- ì¼ë°˜ì ìœ¼ë¡œ ì„œë²„ì—ì„œ corsë¥¼ ì„¤ì •í•˜ë ¤ë©´, `Access-Control-Allow-Origin` í—¤ë”ë¥¼ ì„¤ì •í•œë‹¤.
- expressì—ì„œëŠ” ì¼ë°˜ì ìœ¼ë¡œ cors ë¯¸ë“¤ì›¨ì–´ë¥¼ ì‚¬ìš©í•˜ì—¬ `Access-Control-Allow-Origin` í—¤ë”ë¥¼ ì„¤ì •í•œë‹¤.
- ê·¸ë¦¬ê³  cors ë¯¸ë“¤ì›¨ì–´ì—ì„œ `origin` ì˜µì…˜ ì œê³µí•œë‹¤.
- `origin`ì— ê°’ì„ ì„¤ì •í•˜ë©´ `Access-Control-Allow-Origin`ì— ì§ì ‘ ê°’ì„ ì„¤ì •í•˜ëŠ” ê²ƒê³¼ ê°™ì€ ë™ì‘ì„ í•œë‹¤.

> ğŸ’¡ cors ë¯¸ë“¤ì›¨ì–´ `credentials` ì˜µì…˜ ì„¤ì •ì´ í•„ìš”í•œ ì´ìœ ?

- cors ì˜µì…˜ì—ëŠ” ìê²©ì¦ëª… ìš”ì²­(**credentialed requests**)ì— ì‘ë‹µ í—¤ë”ë¥¼ ì„¤ì •í•˜ëŠ” ê¸°ëŠ¥ì´ ìˆë‹¤.
- ìœ„ì˜ 'fetch API credentials ì˜µì…˜ ì„¤ì •'ì˜ ì„¤ëª…ì²˜ëŸ¼ clientëŠ” ìš”ì²­ì— ì¿ í‚¤ë¥¼ ë‹´ì•„ ë³´ë‚¼ ìˆ˜ ìˆë‹¤.
- ì´ê²ƒì„ ìê²©ì¦ëª… ìš”ì²­(**credentialed requests**)ì´ë¼ê³ í•œë‹¤.
- ì„œë²„ëŠ” ìê²©ì¦ëª… ìš”ì²­ì´ ë“¤ì–´ì™€ë„ ì¼ë°˜ì ì¸ ìš”ì²­ê³¼ ë™ì¼í•˜ê²Œ ì·¨ê¸‰í•˜ê³  ì‘ë‹µí•œë‹¤.
- í•˜ì§€ë§Œ ì„œë²„ê°€ **ìê²©ì¦ëª… ìš”ì²­ì— ì ì ˆí•œ ì‘ë‹µì„ í–ˆë”ë¼ë„** ì‘ë‹µ í—¤ë”ì— `Access-Control-Allow-Credentials: true`ê°€ **ì—†ë‹¤ë©´, ë¸Œë¼ìš°ì €ëŠ” í•´ë‹¹ ìš”ì²­ì— ëŒ€í•œ ì‘ë‹µì„ ê±°ë¶€**í•œë‹¤.
- ì¦‰, í´ë¼ì´ì–¸íŠ¸ì—ì„œ ë°œìƒí•œ ìê²©ì¦ëª… ìš”ì²­ì„ ë¸Œë¼ìš°ì €ê°€ ê±°ë¶€í•˜ì§€ ì•Šê²Œ í•˜ë ¤ë©´ ì‘ë‹µ í—¤ë”ì— `Access-Control-Allow-Credentials: true` í¬í•¨ë˜ì–´ì•¼ í•œë‹¤.


#### 4.2.1. express cors ë¯¸ë“¤ì›¨ì–´ `origin` ì˜µì…˜ ì‚¬ìš©ë°©ë²•

- ëª¨ë“  êµì°¨ ì¶œì²˜ ìš”ì²­ì„ í—ˆìš© - ì™€ì¼ë“œ ì¹´ë“œ(`"*"`) ì‚¬ìš©


{% raw %}
```javascript
cors({ origin: '*' });
// === Access-Control-Allow-Origin: "*"
```
{% endraw %}


- íŠ¹ì • êµì°¨ ì¶œì²˜ ìš”ì²­ë§Œ í—ˆìš© - ì§ì ‘ URL ì„¤ì •


{% raw %}
```javascript
cors({ origin: '<http://localhost:3000>' });
// === Access-Control-Allow-Origin: "<http://localhost:3000>"
```
{% endraw %}


- íŠ¹ì •. êµì°¨ ì¶œì²˜ ìë™ ì„¤ì • - `true` ì‚¬ìš©
- cors ë¯¸ë“¤ì›¨ì–´ëŠ” ìš”ì²­ í—¤ë”ì˜ Originì— ë§ì¶° ìë™ìœ¼ë¡œ ê°’ì„ ì„¤ì •í•´ì£¼ëŠ” ì˜µì…˜ì„ ì§€ì›í•œë‹¤.


{% raw %}
```javascript
cors({ origin: true });
// === Access-Control-Allow-Origin: "${Request Headers Origin}"
```
{% endraw %}


- * ì¤‘ìš”: `true` ì„¤ì •ì€ ì™€ì¼ë“œ ì¹´ë“œ(`"*"`)ì™€ ë‹¤ë¥´ë‹¤. â‡’ `true`ëŠ” ì‘ë‹µ í—¤ë”ì— ì‹¤ì œ ê°’ì„ ë¶€ì—¬í•œë‹¤.
- `cors({ origin: '*' });`

	![2](/assets/img/2022-01-12-í”„ë¡œì íŠ¸--BMW-7.-ë¬¸ì œ-í•´ê²°---ë‹¤ë¥¸-ë„ë©”ì¸-cookie-êµí™˜-ì„¤ì •-ê³¼ì •.md/2.png)

- `cors({ origin: true });`

	![3](/assets/img/2022-01-12-í”„ë¡œì íŠ¸--BMW-7.-ë¬¸ì œ-í•´ê²°---ë‹¤ë¥¸-ë„ë©”ì¸-cookie-êµí™˜-ì„¤ì •-ê³¼ì •.md/3.png)



#### 4.2.2. cors ë¯¸ë“¤ì›¨ì–´ `credentials` ì˜µì…˜ ì‚¬ìš©ë°©ë²•



{% raw %}
```javascript
cors({
	origin: true, // === Access-Control-Allow-Origin: "<http://localhost:3000>"
	credentials: true  // === Access-Control-Allow-Credentials: true
})
```
{% endraw %}


- * **ì¤‘ìš”: `credentials` ì˜µì…˜ê³¼ `origin`ì˜µì…˜ì˜ ì™€ì¼ë“œ ì¹´ë“œ(`"*"`)ëŠ” ê°™ì´ ì‚¬ìš©í•˜ì§€ ëª»í•œë‹¤.
- `Access-Control-Allow-Credential: true` í—¤ë”ëŠ” ë³´ì•ˆìƒì˜ ì´ìœ ë¡œ ëª¨ë“  êµì°¨ ì¶œì € ìš”ì²­ì„ í—ˆìš©í•˜ëŠ” `Access-Control-Allow-Origin: "*"` í—¤ë”ì™€ ê°™ì´ ì‚¬ìš©í•˜ì§€ ëª»í•œë‹¤.
- `Access-Control-Allow-Credential: true` í—¤ë”ë¥¼ ì‚¬ìš©í•˜ë ¤ë©´, `Access-Control-Allow-Origin` í—¤ë”ì— êµ¬ì²´ì ì¸ Originì´ ë“¤ì–´ê°€ì•¼í•œë‹¤.
- ì´ëŸ¬í•œ ì´ìœ ë¡œ cors ë¯¸ë“¤ì›¨ì–´ëŠ” `origin: true` ì˜µì…˜ì„ ì œê³µí•˜ì—¬ `credentials: true` ì˜µì…˜ì™€ ê°™ì´ ì‚¬ìš©í•  ìˆ˜ ìˆê²Œ í•˜ì˜€ë‹¤.


#### 4.3. í¬ë¡¬ ê°œë°œì ëª¨ë“œì—ì„œ `credentials` ì˜µì…˜ ì‚¬ìš©ê³¼ ë¯¸ì‚¬ìš© ë¹„êµ



#### 4.3.1. corsì— credentials ì˜µì…˜ ë¯¸ì‚¬ìš©

1. [CORS preflight ìš”ì²­](https://developer.mozilla.org/ko/docs/Glossary/Preflight_request) ê²°ê³¼ â‡’ Access-Control-Allow-Credentials: true í—¤ë” ì—†ìŒ

	![4](/assets/img/2022-01-12-í”„ë¡œì íŠ¸--BMW-7.-ë¬¸ì œ-í•´ê²°---ë‹¤ë¥¸-ë„ë©”ì¸-cookie-êµí™˜-ì„¤ì •-ê³¼ì •.md/4.png)

2. ë¸Œë¼ìš°ì € ê°œë°œì ëª¨ë“œ CORS error í™•ì¸

	![5](/assets/img/2022-01-12-í”„ë¡œì íŠ¸--BMW-7.-ë¬¸ì œ-í•´ê²°---ë‹¤ë¥¸-ë„ë©”ì¸-cookie-êµí™˜-ì„¤ì •-ê³¼ì •.md/5.png)

3. CORS error ì‘ë‹µ ë‚´ìš© í™•ì¸

	![6](/assets/img/2022-01-12-í”„ë¡œì íŠ¸--BMW-7.-ë¬¸ì œ-í•´ê²°---ë‹¤ë¥¸-ë„ë©”ì¸-cookie-êµí™˜-ì„¤ì •-ê³¼ì •.md/6.png)



#### 4.3.2. corsì— credentials ì˜µì…˜ ì‚¬ìš©

1. CORS preflight ìš”ì²­ ê²°ê³¼ â‡’ `Access-Control-Allow-Credentials: true` í—¤ë” ìˆìŒ

	![7](/assets/img/2022-01-12-í”„ë¡œì íŠ¸--BMW-7.-ë¬¸ì œ-í•´ê²°---ë‹¤ë¥¸-ë„ë©”ì¸-cookie-êµí™˜-ì„¤ì •-ê³¼ì •.md/7.png)

2. signin ì‘ë‹µ í™•ì¸ â‡’ ì¿ í‚¤ë„ ì •ìƒì ìœ¼ë¡œ ì‘ë‹µë°›ê³  ìˆë‹¤.

	![8](/assets/img/2022-01-12-í”„ë¡œì íŠ¸--BMW-7.-ë¬¸ì œ-í•´ê²°---ë‹¤ë¥¸-ë„ë©”ì¸-cookie-êµí™˜-ì„¤ì •-ê³¼ì •.md/8.png)

3. ì¿ í‚¤ ì €ì¥ í™•ì¸ â‡’ signin ìš”ì²­ì—ì„œ ì‘ë‹µë°›ì€ ì¿ í‚¤ë¥¼ ë¸Œë¼ìš°ì €ê°€ ê°€ì§€ê³  ìˆë‹¤.

	![9](/assets/img/2022-01-12-í”„ë¡œì íŠ¸--BMW-7.-ë¬¸ì œ-í•´ê²°---ë‹¤ë¥¸-ë„ë©”ì¸-cookie-êµí™˜-ì„¤ì •-ê³¼ì •.md/9.png)



### 5. 2ë‹¨ê³„ - ìš´ì˜ì¤‘ì¸ Nginxì™€ Proxyì„œë²„ cookie êµí™˜ ì„¤ì •



#### 5.1. 1ë‹¨ê³„ì—ì„œ ì§„í–‰í•œ react, express ìê²©ì¦ëª… ì¿ í‚¤ êµí™˜ ì„¤ì • ì§„í–‰

- express cors ë¯¸ë“¤ì›¨ì–´ originì˜µì…˜ ê°’ë§Œ Nginx ë„ë©”ì¸ìœ¼ë¡œ ì„¤ì •í•œë‹¤.


{% raw %}
```javascript
app.use( cors({ origin: '<http://test.iptime.org>', credentials: true}),);
```
{% endraw %}




#### 5.2. nginx.conf ì—ì„œ proxy ì„¤ì •



{% raw %}
```bash
# ... ìƒëµ
http {

    # 1. í¬ì›Œë“œí•  upstream í”„ë¡ì‹œ ì„œë²„ ì„¤ì •
    upstream api-server {
        server api:8080; # ë„ì»¤ì„œë¹„ìŠ¤ì´ë¦„:í¬íŠ¸
    }

    server {
	    # ... ìƒëµ

        # 2. api ê²½ë¡œ - í”„ë¡ì‹œ ì„¤ì •
        location /api {
            proxy_pass         <http://api-server>;
            proxy_redirect     off;
            proxy_set_header   Host $host;
            # Frowarded í—¤ë” ì„¤ì •
            proxy_set_header   X-Real-IP $remote_addr;
            proxy_set_header   X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header   X-Forwarded-Proto $scheme;
            #
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection "upgrade";
            proxy_cache_bypass $http_upgrade;
            proxy_http_version 1.1;

			# í•´ë‹¹ ì˜µì…˜ì€ api ì„œë²„ì—ì„œ ì²˜ë¦¬í•˜ê³  ìˆë‹¤.
            #add_header 'Access-Control-Allow-Origin' '${origin}';
            #add_header 'Access-Control-Allow-Credentials' 'true';
            #proxy_cookie_path /api "/; SameSite=None; HTTPOnly; Secure";
        }
    }
    # ... ìƒëµ
}
```
{% endraw %}




#### 5.3. express í”„ë¡ì‹œ ì„¤ì •



{% raw %}
```javascript
// express í”„ë¡ì‹œ ì„¤ì •
// ì°¸ê³ : <https://expressjs.com/ko/guide/behind-proxies.html>
app.set('trust proxy', true);
```
{% endraw %}




#### 5.4. express ì‘ë‹µ ì¿ í‚¤ ì˜µì…˜ ì„¤ì •



{% raw %}
```javascript
// express ì‘ë‹µ ê°ì²´ë¥¼ ì‚¬ìš©í•˜ì—¬ ì¿ í‚¤ì— ì—‘ì„¸ìŠ¤ í† í° ì €ì¥
res.cookie(key, accessToken, {
	secure: true // ì¿ í‚¤ë¥¼ httpsì—ì„œë§Œ ì‚¬ìš© í•˜ë„ë¡ ì„¤ì •
	sameSite: 'none' // ëª¨ë“  ë„ë©”ì¸ì—ì„œ ì¿ í‚¤ ì‚¬ìš© í—ˆìš©, *ì´ ì˜µì…˜ì€ httpsì—ì„œë§Œ ê°€ëŠ¥í•˜ë‹¤.
});
```
{% endraw %}




#### 5.4.1 `sameSite` ì˜µì…˜ ì„¤ëª…

- `sameSite: 'strict'` :
	- ì„œë¡œ ë‹¤ë¥¸ ë„ë©”ì¸(êµì°¨ì¶œì²˜)ì—ì„œ ì „ì†¡ ë¶ˆê°€ëŠ¥.
	- ë³´ì•ˆì„±ì€ ë†’ìœ¼ë‚˜ í¸ì˜ê°€ ë‚®ë‹¤.
- `sameSite: 'lax'` :
	- ì„œë¡œ ë‹¤ë¥¸ ë„ë©”ì¸ì´ì§€ë§Œ ì¼ë¶€ ì˜ˆì™¸
	- HTTP get method / a href / link href ì—ì„œëŠ” ì „ì†¡ ê°€ëŠ¥.
- `sameSite: 'none'` :
	- ëª¨ë“  ë„ë©”ì¸ì—ì„œ ì „ì†¡ ê°€ëŠ¥
	- [í•´ë‹¹ ì˜µì…˜ì€ ë¸Œë¼ìš°ì €ì— ë”°ë¼ ë‹¤ë¥¼ ìˆ˜ ìˆë‹¤ê³  í•˜ë©°, í¬ë¡¬ì˜ ê²½ìš° 'none'ì„ ì‚¬ìš©í•œë‹¤.](https://learn.microsoft.com/ko-kr/entra/identity-platform/howto-handle-samesite-cookie-changes-chrome-browser?tabs=dotnet#mitigation-and-samples)
	- **https í™˜ê²½ í•„ìˆ˜**: 2020ë…„ 2ì›” 4ì¼ ë¦´ë¦¬ì¦ˆëœ êµ¬ê¸€ í¬ë¡¬(Google Chrome) 80ë²„ì „ ë¶€í„°ëŠ” httpsì—ì„œë§Œ ë™ì‘í•œë‹¤.


### 6. 3ë‹¨ê³„ - httpsí†µì‹ ì„ ìœ„í•œ ssl ì¸ì¦ì„œ ì„¤ì •



#### 6.1. ë°©ë²•1) openssl ì„¤ì •


opensslì„ ì‚¬ìš©í•˜ëŠ” ë°©ë²•ì€ ì •ì‹ ssl ì¸ì¦ì„œë¥¼ ë°›ëŠ” ë°©ë²•ì´ ì•„ë‹ˆë‹¤. ê·¸ëŸ¼ì—ë„ ì´ ë°©ë²•ì„ ì‚¬ìš©í•˜ëŠ” ì´ìœ ëŠ” ì •ì‹ ë„ë©”ì¸ì´ ì—†ê¸° ë•Œë¬¸ì´ë‹¤. ê°œë°œì‹œì ì—ëŠ” ì •ì‹ ë„ë©”ì¸ì´ ì•„ë‹Œ iptimeì—ì„œ ì œê³µí•˜ëŠ” DDNSë¥¼ ì‚¬ìš©í•˜ì—¬ ì„œë²„ë¥¼ ì˜¬ë ¸ë‹¤. ê·¸ë¦¬ê³  iptime ddnsëŠ” 20ë…„ 7ì›” ê¸°ì¤€ìœ¼ë¡œ ë” ì´ìƒ ì •ì‹ ì¸ì¦ì„œë¥¼ ì œê³µí•´ì£¼ëŠ” ì—…ì²´ê°€ ì—†ë‹¤. ê·¸ë˜ì„œ ë„ë©”ì¸ì´ ì—†ëŠ” ìƒí™©ì—ì„œ ë¶€ë“ì´í•˜ê²Œ opensslì„ ì‚¬ìš©í•˜ì—¬ https í†µì‹ ì„ êµ¬í˜„í•˜ì˜€ë‹¤.



#### 6.1.1. opensslìœ¼ë¡œ ì¸ì¦ì„œ ë°œê¸‰


(ìƒëµ, ì°¸ê³  í™•ì¸)



#### 6.1.2. nginx.conf ssl ì„¤ì •



{% raw %}
```bash
# ...ìƒëµ
http {
    # ê°€ìƒ í˜¸ìŠ¤íŠ¸ ì„œë²„ - opensslì„ ì ìš©í•œ https ì„œë²„
    server {
        listen 443 ssl;
        listen [::]:443;
        server_name jaycloud.iptime.org;

        server_tokens off;

        ## ssl ì„¤ì • - openssl ì „ìš© ##
        ssl_certificate /etc/nginx/ssl/lesstif.com.crt;
        ssl_certificate_key /etc/nginx/ssl/lesstif.com.key;
        ssl_session_cache    shared:SSL:1m;
        ssl_session_timeout  5m;
        ssl_ciphers  HIGH:!aNULL:!MD5;
        ssl_prefer_server_ciphers  on;

		# ...ìƒëµ
    }
    # ...ìƒëµ
}
```
{% endraw %}




### ì°¸ê³  ìë£Œ


1ë‹¨ê³„ ì°¸ê³ 

- 1ë‹¨ê³„ - [ì œë¡œì´ˆ: ](https://www.zerocho.com/category/NodeJS/post/5e9bf5b18dcb9c001f36b275)[**ë‹¤ë¥¸ ë„ë©”ì¸ê°„ ì¿ í‚¤ ì „ì†¡í•˜ê¸°(axiosì™€ express ì˜ˆì œ)**](https://www.zerocho.com/category/NodeJS/post/5e9bf5b18dcb9c001f36b275)
- [1ë‹¨ê³„ - MDN Using Fetch](https://developer.mozilla.org/ko/docs/Web/API/Fetch_API/Using_Fetch#%EC%9E%90%EA%B2%A9_%EC%A6%9D%EB%AA%85credentials%EC%9D%B4_%ED%8F%AC%ED%95%A8%EB%90%9C_request_%EC%9A%94%EC%B2%AD)
- [1ë‹¨ê³„ - MDN cors](https://developer.mozilla.org/ko/docs/Web/HTTP/CORS)

2ë‹¨ê³„ ì°¸ê³ 

- 2ë‹¨ê³„ - [ì„¸ì…˜ê³¼ ì¿ í‚¤https://velog.io/@nmy0502/ì„¸ì…˜ê³¼-ì¿ í‚¤](https://velog.io/@nmy0502/%EC%84%B8%EC%85%98%EA%B3%BC-%EC%BF%A0%ED%82%A4)
- 2ë‹¨ê³„ - [# ë‹¤ë¥¸ ë„ë©”ì¸(í”„ë¡ì‹œ ì„œë²„o) ê°„ ì¿ í‚¤ ê³µìœ https://velog.io/@gbskang/ë‹¤ë¥¸-ë„ë©”ì¸í”„ë¡ì‹œ-ì„œë²„o-ê°„-ì¿ í‚¤-ê³µìœ ](https://velog.io/@gbskang/%EB%8B%A4%EB%A5%B8-%EB%8F%84%EB%A9%94%EC%9D%B8%ED%94%84%EB%A1%9D%EC%8B%9C-%EC%84%9C%EB%B2%84o-%EA%B0%84-%EC%BF%A0%ED%82%A4-%EA%B3%B5%EC%9C%A0)
- 2ë‹¨ê³„, 3ë‹¨ê³„ - [https://cowimming.tistory.com/173](https://cowimming.tistory.com/173)
- [2ë‹¨ê³„ ì—­ë°©í–¥ í”„ë¡ì‹œ ì„¤ì •](https://jjeongil.tistory.com/1490)

3ë‹¨ê³„ ì°¸ê³ 

- [3ë‹¨ê³„ opensslë¡œ ssl ì¸ì¦ì„œ ë°œê¸‰ ë°©ë²•](https://www.lesstif.com/system-admin/openssl-root-ca-ssl-6979614.html)
- [3ë‹¨ê³„ nginx certbotë¥¼ ì‚¬ìš©í•œ ssl ì¸ì¦ì„œ ë°œê¸‰ A](https://lu-coding.tistory.com/88)
- [3ë‹¨ê³„ nginx certbotë¥¼ ì‚¬ìš©í•œ ssl ì¸ì¦ì„œ ë°œê¸‰ B](https://zinirun.github.io/2021/03/31/docker-nginx-certbot/)
- [iptime ddns ssl ì¸ì¦ì„œ ë°œê¸‰ ë¶ˆê°€í•œ ì´ìœ ](https://hi098123.tistory.com/262)
