---
layout: post
date: 2025-05-23
title: "[í”„ë¡œì íŠ¸ | ë˜‘ì†Œ] Route53ì„ ì‚¬ìš©í•´ DDNSë¥¼ êµ¬í˜„í•˜ê¸°"
tags: [ddokso, AWS, Route53, ]
categories: [í”„ë¡œì íŠ¸, ë˜‘ì†Œ, ]
mermaid: true
---


> ğŸ“Œ í•´ë‹¹ ê¸€ì—ì„œëŠ” ê°€ìš© ê°€ëŠ¥í•œ ìì›ì•ˆì—ì„œ DDNSë¥¼ ê°„ë‹¨í•˜ê²Œ êµ¬ì¶•í•œ ì‚¬ë¡€ë¥¼ ì†Œê°œí•©ë‹ˆë‹¤.  
> (ê³µìœ ê¸° DDNSë¥¼ ì‚¬ìš©í•˜ì§€ ëª»í•˜ëŠ” ìƒí™©ì„ ì „ì œë¡œ ì‘ì„±ë˜ì—ˆìŠµë‹ˆë‹¤.)


**ğŸ‘€Â ê²°ê³¼ ë¯¸ë¦¬ë³´ê¸°**



```mermaid
sequenceDiagram
    participant script
    participant ifconfig.me
    
    participant DB
    participant AWS-Route53
    participant DNS
    
    Note over script,DB: 1ë‹¨ê³„) IP ë³€ê²½ ê°ì§€
    script->>ifconfig.me: curlë¡œ IP í™•ì¸
    script->>DB: ë§ˆì§€ë§‰ ë³€ê²½ IP ì¡°íšŒ
    script->>script: IP ë³€ê²½ ì²´í¬

    Note over script,DNS: 2ë‹¨ê³„) DNSì— ì „íŒŒë¥¼ í†µí•´ DDNS êµ¬í˜„
    script->>DB: IP ë³€ê²½ì‚¬í•­ ì˜ì†í™”
    script->>AWS-Route53: DNS ë ˆì½”ë“œì— ë§¤í•‘ëœ IP ë³€ê²½ ìš”ì²­
    AWS-Route53-->>DNS: ì „íŒŒ(ìµœëŒ€ 1ë¶„ ì†Œìš”)
    AWS-Route53->>script: ì‘ë‹µ
```




### 1. ë°°ê²½ ì„¤ëª…


ë˜‘ì†ŒëŠ” ë¹„ìš© ì ˆê°ì„ ëª©ì ìœ¼ë¡œ Local Network í™˜ê²½ì„ ì ê·¹ í™œìš©í•˜ê³  ìˆìŠµë‹ˆë‹¤.


![0](/assets/img/2025-05-23-í”„ë¡œì íŠ¸--ë˜‘ì†Œ-Route53ì„-ì‚¬ìš©í•´-DDNSë¥¼-êµ¬í˜„í•˜ê¸°.md/0.png)


Local Network íŠ¹ì„±ìƒ IPê°€ ë³€ê²½ë˜ëŠ” ê²½ìš°ê°€ ë°œìƒí•©ë‹ˆë‹¤. ê·¸ë¦¬ê³  IPê°€ ë³€ê²½ë˜ë©´ Local Network ìˆëŠ” Serverë¥¼ ë°”ë¼ë³´ëŠ” ì„œë¹„ìŠ¤ëŠ” ëª¨ë‘ ì¥ì• ê°€ ë°œìƒí•˜ê²Œ ë©ë‹ˆë‹¤.


> ğŸ’¡ ì ê¹!! ê³µìœ ê¸°ì—ì„œ ë¬´ë£Œë¡œ DDNS ê¸°ëŠ¥ì„ ì œê³µí•˜ëŠ”ë° ì™œ ë”°ë¡œ ë§Œë“¤ì—ˆë‚˜ìš”?


ì™¸ë¶€ ì¸í„°ë„·ê³¼ Home Networkë¥¼ ì—°ê²°í•´ë³¸ ê²½í—˜ì´ ìˆìœ¼ì‹  ë¶„ë“¤ì€ ì´ìƒí•œ ì ì„ ëŠë¼ì…¨ì„ ê²ë‹ˆë‹¤.


ìš°ë¦¬ê°€ í”í•˜ê²Œ ì‚¬ìš©í•˜ëŠ” ê³µìœ ê¸°ëŠ” Network ì¥ë¹„ ì¢…í•©ì„ ë¬¼ ì„¸íŠ¸ì…ë‹ˆë‹¤. ë•Œë¬¸ì— í†µì‹ ì‚¬ ê³µìœ ê¸°, iptime, í‹°í”¼ë§í¬ ê°™ì€ ê³µìœ ê¸°ë¥¼ ì‚¬ìš©í•˜ëŠ” ì‚¬ìš©ìëŠ” ëª¨ë‘ ê° ë²¤ë”ë“¤ì´ ìš´ì˜í•˜ëŠ” DDNSë¥¼ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤. (ê³µìœ ê¸° DDNS ì„¤ì •ì— ê´€í•´ ê¶ê¸ˆí•˜ë‹¤ë©´ [í•´ë‹¹ í¬ìŠ¤íŠ¸](https://dbwogus94.github.io/posts/%ED%94%84%EB%A1%9C%EC%A0%9D%ED%8A%B8-BMW-3.-%EC%9D%B8%ED%94%84%EB%9D%BC1-On-premise-%EC%84%9C%EB%B2%84-%EC%84%B8%ED%8C%85/#3-iptime%EA%B3%B5%EC%9C%A0%EA%B8%B0%EB%A5%BC-%EC%82%AC%EC%9A%A9%ED%95%9C-%EC%99%B8%EB%B6%80-%EC%A0%91%EC%86%8D-%EC%84%A4%EC%A0%95-with-ddns)ë¥¼ ì°¸ê³ í•´ì£¼ì„¸ìš”.)


ë²¤ë”ì—ì„œ ìš´ì˜í•˜ëŠ” DDNSë¥¼ ì‚¬ìš©í•˜ë©´ í¸í•˜ì§€ë§Œ ë‚´ë¶€ì ì¸ ì‚¬ì •ê³¼ ì´í›„ ìœ ì—°í•˜ê²Œ ì‚¬ìš©í•˜ì§€ ëª»í•˜ëŠ” ë‹¨ì ë“±ì˜ ì´ìœ ë¡œ ê³µìœ ê¸° ë²¤ë”ì˜ DDNSë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šê³  ì§ì ‘ ë§Œë“¤ê¸°ë¡œ í–ˆìŠµë‹ˆë‹¤.



### 2. ë¬¸ì œ í•´ê²°ì„ ìœ„í•´ ê³ ë ¤ëœ í›„ë³´êµ°


ì²˜ìŒë¶€í„° DDNSë¥¼ ìƒê°í•œ ê²ƒì€ ì•„ë‹ˆì˜€ìŠµë‹ˆë‹¤. 


ì£¼ëœ ìš”êµ¬ì‚¬í•­ì€ â€œIP ë³€ê²½ì‹œ ì¥ì• ê°€ ë°œìƒí•˜ì§€ ì•Šê³  ì ‘ê·¼ ê°€ëŠ¥í•´ì•¼ í•œë‹¤.â€ ì˜€ê³ 


ì´ë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ ë‹¤ì–‘í•œ í›„ë³´êµ°ì´ ìˆì—ˆìŠµë‹ˆë‹¤.

1. SSH í”„ë¡ì‹œ í„°ë¯¸ë„
2. DBë¥¼ í†µí•´ ë³€ê²½ëœ IPë¥¼ ì˜ì¡´í•œë‹¤.
3. DDNSë¥¼ ì‚¬ìš©í•œë‹¤.
4. â€¦


#### 2.1. â€œDDNSâ€ + â€œë³€ê²½ëœ IPë¥¼ DB ì €ì¥í•œë‹¤.â€


ê·¸ë¦¬ê³  ì´ ì¤‘ ë‘ê°€ì§€ ë°©ë²•ì„ í˜¼í•©í•´ì„œ ì‚¬ìš©í•˜ê¸°ë¡œ í•©ë‹ˆë‹¤.

1. **DDNS**: ë©”ì¸ì€ DDNSë¥¼ ì‚¬ìš©í•´ì„œ ê´€ë¦¬í•©ë‹ˆë‹¤.
2. **DB**: DBì— ë³€ê²½ëœ IP ì •ë³´ë¥¼ ì €ì¥í•œë‹¤.

> ğŸ’¡ ì™œ ë‘ê°€ì§€ ë°©ë²•ì„ í˜¼í•©í–ˆì„ê¹Œ?


DDNSì— ë³€ê²½ì´ ë°€ë¦¬ëŠ” ê²½ìš°ì— DBì— ì €ì¥ëœ IPë¥¼ ì‚¬ìš©í•´ í†µì‹ í•  ìˆ˜ ìˆê¸° ë•Œë¬¸ì…ë‹ˆë‹¤. 


ì´ëŸ¬í•œ ë°©ì§€ì±…ì„ ë§ˆë ¨í•œ ì´ìœ ëŠ” â€œRoute53ì— Record ë³€ê²½ì€ ìµœëŒ€ 1ë¶„ì´ ê±¸ë¦´ ìˆ˜ ìˆë‹¤â€ê³  ì•ˆë‚´ë˜ì–´ ìˆê¸° ë•Œë¬¸ì…ë‹ˆë‹¤. ( í…ŒìŠ¤íŠ¸ì—ì„œ IP ë³€ê²½ì€ 1ì´ˆ ë‚´ë¡œ ì´ë£¨ì–´ì¡ŒìŠµë‹ˆë‹¤. )



### 3. DDNS êµ¬ì¶•í•˜ê¸°



#### 3.1. Table DDL ì •ì˜



{% raw %}
```sql
CREATE TABLE `admin_ip_history` (
  `id` bigint NOT NULL AUTO_INCREMENT COMMENT 'ID',
  `createdAt` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP COMMENT 'ìƒì„±ì¼',
  `updatedAt` datetime NOT NULL DEFAULT CURRENT_TIMESTAMP ON UPDATE CURRENT_TIMESTAMP COMMENT 'ìˆ˜ì •ì¼',
  `ip` varchar(255) NOT NULL COMMENT 'ip address',
  `name` varchar(255) NOT NULL COMMENT 'ëª…ì¹­',
  `version` int NOT NULL DEFAULT '1' COMMENT 'ë²„ì „ ë²ˆí˜¸',
  `originId` bigint NOT NULL DEFAULT '0' COMMENT 'ì´ˆê¸° ì›ë³¸ IP PK',
  `note` text COMMENT 'ë…¸íŠ¸',
  PRIMARY KEY (`id`)
) ENGINE=InnoDB AUTO_INCREMENT=1 DEFAULT CHARSET=utf8mb4 COLLATE=utf8mb4_0900_ai_ci;
```
{% endraw %}



**âœ…Â ë°ì´í„° ì˜ˆì‹œ**


`version`ê³¼ `originId`ë¥¼ ì‚¬ìš©í•´ IPê°€ ë³€ê²½ì„ ì¶”ì í•©ë‹ˆë‹¤.


| id | createdAt    | updatedAt    | ip              | name         | version | originId | note         |
| -- | ------------ | ------------ | --------------- | ------------ | ------- | -------- | ------------ |
| 1  | yyyy-MM-dd â€¦ | yyyy-MM-dd â€¦ | 111.111.111.111 | ddokso-scrap | 1       | 1        | ì´ˆê¸° IP INSERT |
| 2  | yyyy-MM-dd â€¦ | yyyy-MM-dd â€¦ | 222.222.222.222 | ddokso-scrap | 2       | 1        | ë³€ê²½ IP INSERT |
| 3  | yyyy-MM-dd â€¦ | yyyy-MM-dd â€¦ | 333.333.333.333 | ddokso-scrap | 3       | 1        | ë³€ê²½ IP INSERT |

undefined
**âœ…Â í™œìš© ì˜ˆì‹œ**


ì›ë³¸ IPë¥¼ ì‚¬ìš©í•´ì„œ ë§ˆì§€ë§‰ ë³€ê²½ëœ IPë¥¼ ì¡°íšŒí•©ë‹ˆë‹¤.



{% raw %}
```sql
SELECT h1.*
FROM admin_ip_history h1
JOIN (
  SELECT originId, MAX(version) as max_version
  FROM admin_ip_history
  WHERE originId = 1 -- ì´ˆê¸° ì›ë³¸ IP PK
  GROUP BY originId
) h2 ON h1.originId = h2.originId AND h1.version = h2.max_version
```
{% endraw %}




#### 3.2. AWS SDK ì‚¬ìš© ì¤€ë¹„

1. AWS IAMì—ì„œ Route53 ì „ìš© ê¶Œí•œ ìƒì„±
2. ìƒì„±ëœ ê¶Œí•œì—ì„œ Access Tokenì„ ìƒì„±í•œë‹¤.


#### 3.3. ìŠ¤í¬ë¦½íŠ¸ ë¡œì§ ì„¤ê³„



```mermaid
sequenceDiagram
    participant script
    participant ifconfig.me
    
    participant DB
    participant AWS-Route53
    participant DNS
    
    Note over script,DB: 1ë‹¨ê³„) IP ë³€ê²½ì„ í™•ì¸í•œë‹¤.
    script->>ifconfig.me: curlë¡œ IP í™•ì¸
    script->>DB: ë§ˆì§€ë§‰ ë³€ê²½ IP ì¡°íšŒ
    script->>script: IP ë³€ê²½ ì²´í¬

    Note over script,DNS: 2ë‹¨ê³„) DNSì— ì „íŒŒë¥¼ í†µí•´ DDNS êµ¬í˜„í•œë‹¤.
    script->>DB: IP ë³€ê²½ì‚¬í•­ ì˜ì†í™”
    script->>AWS-Route53: DNS ë ˆì½”ë“œì— ë§¤í•‘ëœ IP ë³€ê²½ ìš”ì²­
    AWS-Route53-->>DNS: ì „íŒŒ(ìµœëŒ€ 1ë¶„ ì†Œìš”)
    AWS-Route53->>script: ì‘ë‹µ
```



**1ë‹¨ê³„) IP ë³€ê²½ í™•ì¸**

1. `curl -s ifconfig.me` ë¥¼ í†µí•´ í˜„ì¬ ì‚¬ìš©ì¤‘ì¸ IPë¥¼ ì°¾ìŠµë‹ˆë‹¤.
2. DBì— ì €ì¥ëœ ë§ˆì§€ë§‰ IPì™€ ë¹„êµí•©ë‹ˆë‹¤.
3. ë‘ ê°’ì´ ë‹¤ë¥´ë‹¤ë©´ ë³€ê²½ ë¡œì§ì„ ì‹¤í–‰í•©ë‹ˆë‹¤.

**2ë‹¨ê³„) IP ë³€ê²½ ìˆ˜í–‰**

1. `admin_ip_history`ì— ì‹ ê·œ ë²„ì „ìœ¼ë¡œ Insertë¥¼ ìˆ˜í–‰í•©ë‹ˆë‹¤.
2. AWS SDKë¥¼ ì‚¬ìš©í•´ì„œ Route53ì˜ A Recordì— ë§¤í•‘ëœ IP ìˆ˜ì •ì„ ìš”ì²­í•©ë‹ˆë‹¤.


### **4. êµ¬í˜„ëœ ìŠ¤í¬ë¦½íŠ¸ ì˜ˆì‹œ**



{% raw %}
```typescript
/**
 * IP ë³€ê²½ì„ ì¶”ì í•˜ê³  ì½”ë“œë¡œ DDNS êµ¬í˜„í•˜ëŠ” ìŠ¤í¬ë¦½íŠ¸
 * - ì‹œì‘ì „ í™˜ê²½ë³€ìˆ˜ë¥¼ ê²€ì¦í•œë‹¤.
 * - DB ì»¤ë„¥ì…˜ì„ ì–»ì–´ì˜¨ë‹¤.
 *    1. DBì—ì„œ IPë¥¼ ì¡°íšŒí•˜ê³  í˜„ì¬ ì™¸ë¶€ IPë‘ ë¹„êµí•œë‹¤.
 *    2. IPê°€ ë‹¤ë¥´ë‹¤ë©´ ìµœì‹  IPë¥¼ DBì— Insert í•œë‹¤.
 *    3. AWS Route53 ë ˆì½”ë“œì— ì‹ ê·œ IPë¥¼ ë§¤í•‘ì‹œí‚¨ë‹¤.
 */
export const main = async (config: MainConfig) => {
  const configManager = new ConfigManager(config);
  // í™˜ê²½ë³€ìˆ˜ ê²€ì¦
  configManager.validate();
  // DB ì—°ê²°
  return await runDB(configManager.connectionConfig, async (connection) => {
    /** Local Iptime ì´ˆê¸° ì›ë³¸ ë ˆì½”ë“œ ID */
    const IP_HISTORY_ORIGIN_ID = 1;
    const repository = new AdminIpHistoryRepository(connection);
    const routerRecordManager = new Route53RecordManager(
      configManager.route53RecordManagerConfig,
    );

    // originIdê°€ 1ì¸ ìµœì‹  ë²„ì „ ë ˆì½”ë“œ ê°€ì ¸ì˜¤ê¸°
    const latestRecord =
      await repository.findOneLatestVersionByOriginId(IP_HISTORY_ORIGIN_ID);

    if (!latestRecord) {
      throw new Error(
        `âŒ originIdê°€ ${IP_HISTORY_ORIGIN_ID}ì¸ ë ˆì½”ë“œê°€ ì—†ìŠµë‹ˆë‹¤. ì´ˆê¸° ë°ì´í„° ìƒì„±ì´ í•„ìš”í•©ë‹ˆë‹¤.`,
      );
    }

    // í˜„ì¬ IP ê°€ì ¸ì˜¤ê¸°
    const currentIp = await getIp();
    if (latestRecord.ip === currentIp) {
      console.log('\nğŸŸ¡ IPê°€ ë³€ê²½ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤.');
      return;
    }

    console.group('\nğŸŸ¢ IPê°€ ë³€ê²½ë˜ì–´ ìŠ¤í¬ë¦½íŠ¸ë¥¼ ì§„í–‰í•©ë‹ˆë‹¤.');
    // step 1) IP ë¹„êµ í›„ ë‹¤ë¥´ë©´ ìƒˆ ë²„ì „ ì‚½ì…
    await runStep1_InsertNewIp(repository)(currentIp, latestRecord);

    // step 2) Route53 ë ˆì½”ë“œ ì—…ë°ì´íŠ¸ ìˆ˜í–‰
    await runStep2_UpdateRoute53Record(routerRecordManager)(
      configManager.recordIdentity, // Route53 ë ˆì½”ë“œ ì‹ë³„ê°’
      currentIp,
    );
    console.groupEnd();
  });
};

/**
 * curlì„ ì‚¬ìš©í•´ ì™¸ë¶€ IP ì£¼ì†Œë¥¼ ê°€ì ¸ì˜µë‹ˆë‹¤.
 * - ì‚¬ìš©ëœ ëª…ë ¹: `curl -s ifconfig.me`
 * @returns ì™¸ë¶€ IPv4 ì£¼ì†Œ
 */
async function getIp(retryCount = 3) {
  try {
    const { stdout } = await execAsync('curl -s ifconfig.me');
    return stdout.trim();
  } catch (error) {
    if (retryCount > 0) return await getIp(retryCount - 1);

    // Note: ChildProcessë¥¼ í†µí•´ ìš”ì²­, ì—ëŸ¬ stackì— ì¡íˆì§€ ì•Šì•„ ì‹ ê·œ Errorë¥¼ ìƒì„±
    console.error(error);
    throw new Error('IP ì£¼ì†Œë¥¼ ê°€ì ¸ì˜¤ëŠ”ë° ì‹¤íŒ¨í–ˆìŠµë‹ˆë‹¤.');
  }
};

/**
 * DBì— ìƒˆ ë²„ì „ Insertë¥¼ ìˆ˜í–‰í•©ë‹ˆë‹¤.
 * - ì»¤ë§ í•¨ìˆ˜ ë¦¬í„´
 * @param repository
 * @returns
 */
function runStep1_InsertNewIp(repository: AdminIpHistoryRepository) {
  return async (currentIp: string, latestRecord: AdminIpHistory) => {
    console.log('Step 1) DBì— ì‹ ê·œ IPë¥¼ ë³€ê²½ì‚¬í•­ ë°˜ì˜ì„ ì‹œì‘í•©ë‹ˆë‹¤.');
    await repository.insertNewIp(currentIp, latestRecord);
  };
}
/**
 * Route53 ë ˆì½”ë“œ ì—…ë°ì´íŠ¸ ìˆ˜í–‰
 * - ì»¤ë§ í•¨ìˆ˜ ë¦¬í„´
 * @param recordManager
 * @returns
 */
function runStep2_UpdateRoute53Record(recordManager: Route53RecordManager) {
  return async (recordIdentity: Route53RecordIdentity, newIp: string) => {
    console.log('\nStep 2) Route53 ë ˆì½”ë“œì— ì‹ ê·œ IP ì—…ë°ì´íŠ¸ ì‹œì‘í•©ë‹ˆë‹¤.');
    await recordManager.upsertSubdomainARecord(recordIdentity, newIp);
    await setTimeout(3000);
    
    const aRecord = await recordManager.findRecord(recordIdentity);
    if (aRecord?.ResourceRecords?.[0]?.Value !== newIp) {
	    // 3ì´ˆ ë’¤ ë³€ê²½ì´ ë˜ì§€ ì•Šì•˜ë‹¤ë©´ ì‹¤íŒ¨ë¼ê³  ê°€ì •í•œë‹¤.
      throw new Error('âŒ Route53 ë ˆì½”ë“œ ì—…ë°ì´íŠ¸ ì‹¤íŒ¨');
    }
  };
}
```
{% endraw %}




### 5. ê²°ë¡ 


DDNSë¥¼ ì‚¬ìš©ì˜ ê°€ì¥ í° ì¥ì ì€ IPë¥¼ ì§ì ‘ ì˜ì¡´í•˜ì§€ ì•ŠëŠ”ë‹¤ëŠ” ê²ƒì…ë‹ˆë‹¤.


ê²°ê³¼ì ìœ¼ë¡œ APIì—ì„œ ë‚´ë¶€ HTTP ìš”ì²­, ì›ê²©ì—ì„œ shell ì ‘ê·¼ë„ ì–¸ì œë“  DDNSë¥¼ í†µí•´ ê°€ëŠ¥í•˜ê²Œ ë©ë‹ˆë‹¤.

