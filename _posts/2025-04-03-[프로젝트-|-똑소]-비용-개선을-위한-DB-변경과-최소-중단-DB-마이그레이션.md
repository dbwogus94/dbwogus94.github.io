---
layout: post
date: 2025-04-03
title: "[프로젝트 | 똑소] 비용 개선을 위한 DB 변경과 최소 중단 DB 마이그레이션"
tags: [ddokso, DB, ]
categories: [프로젝트, 똑소, ]
mermaid: true
---


> 📌 똑소 2.0을 진행하면 DB를 점진적으로 마이그레이션한 과정을 소개합니다.  
> - 핵심 전략은 레거시 DB와 신규 DB에 동시에 데이터를 쌓는 방법입니다.


**👀 결과 미리보기**


**ℹ️  ASIS - AWS RDS**


![0](/assets/img/2025-04-03-프로젝트--똑소-비용-개선을-위한-DB-변경과-최소-중단-DB-마이그레이션.md/0.png)


**ℹ️ TOBE - NCP Cloud DB**


![1](/assets/img/2025-04-03-프로젝트--똑소-비용-개선을-위한-DB-변경과-최소-중단-DB-마이그레이션.md/1.png)



### 1. 배경 설명


똑소 2.0으로 개발 과정에서 가장 먼저 논의된 것은 **“데이터 정제”**와 **“DB이관”** 입니다.

- AWS 크레딧 종료가 되어, 이후 크레딧을 받은 NCP로 DB를 이관하기로 결정합니다.
- 똑소 2.0을 위해 데이터를 줄이는 작업을 해야 했기 때문에 동시에 진행하기로 합니다.


#### 1.1. 고민 과정


무중단 이관을 생각했다면 CDC(Changed Data Capture)를 사용하는 등의 방향을 생각했겠지만, 작은 서비스 특성상 복잡한 과정 없이 서비스를 중단하고 이관하는게 가장 좋은 방향이라 생각되었습니다.


하지만 이 시점에 여러가지 상황이 복합적으로 연결되어 있어 고민을 하게됩니다.

1. 똑소 2.0 데이터 마이그레이션
2. 다른 클라우드로 DB 이관
3. 신규 스크래퍼와 배치 플로우 검증

먼저 데이터 마이그레이션을 진행하지 않고, DB 전체를 이관 하기에는 쌓여있는 데이터가 부담되었습니다.

- 똑소 상품 300만개 * 10개월치 가격 데이터 등등
- 스크래핑 원본 데이터 * 10개월치 가격 * 최신화 될 때 마다 쌓이는 가격 정보
- 등등 전체 데이터가 60GB를 넘은 상황

⇒ 마이그레이션과 함께 다른 클라우드로 DB를 이관하는 작업을 같이 진행하는게 좋은 방법이라 판단했습니다.


거기에 더해 2.0 기획에 맞춰 신규 스크래퍼를 구현 했고 검증해야 했던 상황이였습니다. 


⇒ 서비스 특성상 오픈 전에 가격 데이터가 쌓여 있어야 했기 때문에 미룰 수 없는 상황이 되었습니다.


여러 가치 판단 끝에 **기존 DB와 신규 DB를 동시에 올려두고 점진적으로 작업을 진행**하기로 결정합니다.
(이후 찾아보니 이러한 방식도 “최소 중단 마이그레이션” 이라 말할 수 있다는 것을 알게되었습니다.)



### 2. 이관 시나리오


> 💡 스크립트 작성부터 전체 이관에 걸린 시간은 2주 조금 더 걸렸습니다.   
> 그렇지만 **실제 서비스가 중단된 시간은 새벽에 1시간** 남짓 한 시간뿐이였습니다.


데이터 이관은 크게 1차 ~ 3차로 나누어 진행되었습니다.

- 1차에서는 “운영에 영향을 받지 <u>않는</u> 데이터 이관”에 집중합니다.
- 2차에서는 “신규 정책을 담은 스크래퍼 서비스에 정상적으로 적용”에 집중합니다.
- 3차에서는 “서비스를 중지하고 운영에 영향을 받는 데이터 최종 이관”에 집중합니다.


#### 2.1.  1차 - 운영에 영향을 받지 <u>않는</u> 데이터 이관


![2](/assets/img/2025-04-03-프로젝트--똑소-비용-개선을-위한-DB-변경과-최소-중단-DB-마이그레이션.md/2.png)

1. 마이그레이션 script를 미리 구현 합니다.
2. NCP DB 인스턴스 임대하고 셋팅합니다.
3. 1차 데이터 이관 - 서비스 운영에 영향을 받지 않는 데이터를 먼저 이관합니다.
4. 검증 스크립트와 개발 서버를 통해 무결성을 검증합니다.


#### 2.2.  2차 - 신규 Scraper와 배치 검증


![3](/assets/img/2025-04-03-프로젝트--똑소-비용-개선을-위한-DB-변경과-최소-중단-DB-마이그레이션.md/3.png)

1. AWS DB, NCP DB에 신규 스크래퍼를 동시에 적용합니다.
2. AWS DB, NCP DB에 동일한 배치를 적용합니다.
3. 검수기간 - N일간 AWS DB와 NCP DB간 차이가 없는지 확인합니다.


#### 2.3.  3차 - 운영에 영향을 받는 데이터 최종 이관


![4](/assets/img/2025-04-03-프로젝트--똑소-비용-개선을-위한-DB-변경과-최소-중단-DB-마이그레이션.md/4.png)

1. **D-day** 서비스 중단
2. 2차 데이터 이관 - 유저 데이터, 랭킹 정보 등 라이브한 상황에 영향을 받는 데이터 이관합니다.
3. 최종 점검 후 DB를 변경하고 서비스 오픈합니다.
4. 이후 추가적인 모니터링 기간을 가지고 기존 AWS DB는 종료합니다.


### 3. 장/단점 분석


> 💡 작업이 모두 끝나고 글을 쓰는 시점에 가볍게 회고하며 장/단점을 정리했습니다.



#### 3.1. 장점

1. **안정적인 점진적 이관**

	두 개의 DB를 이원화하여 동시에 데이터를 쌓는 전략을 통해, 데이터 이관을 서두르지 않고 단계적으로 준비하고 검증할 수 있었습니다. 이는 마이그레이션 과정에서 발생할 수 있는 문제(실수)를 안정적으로 체크하며 진행할 수 있게 했습니다.

2. **높은 복원력과 장애 대응**

	이관 기간 내내 기존 DB가 활성 상태를 유지하므로, 만약 신규 DB에서 문제가 발생하더라도 즉시 기존 시스템으로 되돌아갈 수 있는 '안전장치'가 마련되어 있었습니다. 

3. **서비스 중단 시간 최소화**

	전체 이관 과정은 2주 이상 소요되었지만, 실제 서비스 중단은 사용자 데이터처럼 실시간 동기화가 필수적인 데이터를 옮기는 데 필요한 1시간 남짓에 불과했습니다. 이를 통해 사용자 경험에 미치는 영향을 최소화할 수 있었습니다.



#### 3.2. 단점

1. **완벽한 데이터 일치의 포기**

	1차 이관 스크립트가 실행되는 동안 변경된 과거 데이터는 CDC나 바이너리 로그 변경 사항 추적 같은 실시간 동기화 기법을 적용하지 않는 한 유실될 수 있습니다. 이 방법은 완벽한 데이터 일치보다는 안정성과 단순성을 우선한 전략입니다.

2. **필연적인 서비스 중단 발생**

	유저 데이터처럼 유실에 민감한 정보는 결국 서비스 중단 후 이관해야 합니다. '무중단'이 아닌 '최소 중단'을 목표로 했기에, 짧지만 서비스 중단은 반드시 발생해야 하는 한계가 있습니다.



### 4. 정리


이 전략은 서비스를 중단하지 않는다는 점에도 좋지만, 개인적으로 그보다 좋은 건 작업을 진행하는 개발자에게 안전장치를 계속 제공할 수 있다는 점입니다. (도움을 받을 수 없기 때문에 안전장치는 더욱더 필요했습니다.)


DB를 마이그레이션하고 이관하는 작업은 항상 어렵습니다. 실수 단 한 번이 치명적으로 이어지기 때문입니다.


다행히 직접적인 실수를 해보지 않았지만 간접적로는 경험했기 때문에 안전장치를 두고 개발하는 것이 매우 중요하다고 생각했습니다.


이 글에서 소개된 전략은 똑소 서비스 처럼 데이터를 외부에서 공급받는 경우 효과적일 수 있습니다. 흘러 들어오는 데이터를 일시적으로 막고 작업을 할 수 있기 때문에 추가적인 인프라 없이도 마이그레이션을 진행할 수 있기 때문입니다. 


시간이 흐르고 보니 조금 더 좋은 방법들이 떠오르긴 합니다. 하지만 당시에는 최선의 선택이었다고 생각합니다.

