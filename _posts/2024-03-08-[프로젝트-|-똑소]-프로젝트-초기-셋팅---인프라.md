---
layout: post
date: 2024-03-08
title: "[프로젝트 | 똑소] 프로젝트 초기 셋팅 - 인프라"
tags: [AWS, github-action, ]
categories: [프로젝트, 똑소, ]
mermaid: true
---



### 1. 인프라 설계 및 세팅


> 📌 똑소 서비스는 두 가지 클라우드 플렛폼을 사용하여 서비스하고 있습니다.

- 운영환경 **AWS(Amazon Web Services)**
- 개발환경 **NCP(Naver Cloud Platform)**

> 💡 왜 하나의 클라우드 서비스가 아닌 두 가지 클라우드 서비스를 사용하게 되었을까요?


초기 클라우드 선정 과정 부터 쉽지 않았습니다.


프로젝트 리더분이 비용을 최소화에 대한 의지를 내보였고, 이 과정에서 KT 클라우드, NCP 클라우드 같은 국내 클라우드가 후보에 들었습니다. 국내 클라우드는 많은 크래딧을 제공하는 프로모션이 있었기 때문입니다.


하지만 팀내에 클라우드 서비스를 직접적으로 다룰 수 있는 개발자가 없었습니다.
때문에 제가 메인으로 인프라 세팅을 담당하게 되었고, 고민 끝에 최선의 타협을 했습니다. 


여러 의사 결정 끝에 메인 서비스는 AWS를 사용하고, 개발 서버나 추가 스크래핑 서버는 가장 크래딧을 많이 제공하는 NCP를 사용하기로 결정했습니다.



#### 1.1. 운영 환경 인프라 셋팅


똑소 서비스를 운영하는데 필요한 필수 자원은 **AWS**를 사용합니다. 


![0](/assets/img/2024-03-08-프로젝트--똑소-프로젝트-초기-셋팅---인프라.md/0.png)

1. DNS는 `Route53`을 사용합니다.
	- 초기에는 도메인이 `가비아`에 있었으며, 이후 편의성을 위해 `Route53`으로 도메인을 이관했습니다.
2. 프론트 서버의 경우 관리 편의성을 위해 `Amplify`를 사용합니다.
	- Web Server - Nextjs 기반의 똑소 웹 호스팅 서버
3. API 서버는 `EC2`를 사용하며, Https 사용과 스케일링 위해 ALB를 사용했습니다.
	- API Server - 똑소 서비스에 필요한 모든 API 제공
4. Scrap 서버는 `EC2`를 사용, 외부와는 API 서버를 통해 통신하기 때문에 따로 ALB를 붙이지 않았습니다.
	- Scrap Server: API 서버와 통신, URL 검색기능 제공
	- Notification Server: 이메일 알림, 푸시 알림
	- Batch Server
5. DB의 경우 여러가지 이유에 따라 `Aurora Mysql`을 사용하기로 했습니다.
	- 주된 이유는 안정성과 관리의 편의성 그리고 **I/O 비용이 발생하지 않기 때문에 사용**했습니다.


#### 1.2. 개발 환경 인프라 셋팅


API 서버와 직접적인 의존성이 없는 로직과 개발 서버는 **NCP**를 사용합니다.


![1](/assets/img/2024-03-08-프로젝트--똑소-프로젝트-초기-셋팅---인프라.md/1.png)

1. Domain이 Route53에 있기 때문에 Route53을 통해 호스팅 되도록 세팅했습니다.
2. 개발 서버의 경우 단일 서버를 임대하고, Mysql을 직접 설치 사용중입니다.


### 2. 배포 설계와 환경 세팅


> 📌 배포 작업은 특정 클라우드에 종속되지 않는 Github Actions을 적극 사용하고 있습니다.


![2](/assets/img/2024-03-08-프로젝트--똑소-프로젝트-초기-셋팅---인프라.md/2.png)



#### 배포 플로우 정리


![3](/assets/img/2024-03-08-프로젝트--똑소-프로젝트-초기-셋팅---인프라.md/3.png)

- `Build`는 현재는 빌드 테스트를 수행하고 있으며, 이후에는 테스트를 수행할 예정입니다.
- `Deploy`는 여러 클라우드를 사용하기 때문에 [**github self-hosted runner**](https://docs.github.com/ko/actions/hosting-your-own-runners/managing-self-hosted-runners/about-self-hosted-runners)**를 인스턴스에 설치해서 배포를 수행합니다.**

💡 docker로 환경이 변경된다면?

- Build에서는 docker image를 빌드하고 레지스트리에 업로드합니다.
- Deploy에서는 레지스트리에서 빌드된 image를 다운로드하고 실행합니다.


#### **github actions 대시보드 결과 확인**


![4](/assets/img/2024-03-08-프로젝트--똑소-프로젝트-초기-셋팅---인프라.md/4.png)


**`Build`** **실행 결과**


![5](/assets/img/2024-03-08-프로젝트--똑소-프로젝트-초기-셋팅---인프라.md/5.png)


주된 플로우

1. _node_modules 캐시 설정_
2. 빌드 테스트

**`Deploy`** **실행 결과**


![6](/assets/img/2024-03-08-프로젝트--똑소-프로젝트-초기-셋팅---인프라.md/6.png)


주된 플로우

1. _node_modules 캐시 설정_
2. 빌드 수행
3. 백그라운드에서 빌드된 nodejs 서버 실행
